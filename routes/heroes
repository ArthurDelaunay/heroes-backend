const express = require("express")
const superHeroes = require("../superHeroes")
const { verifyUser } = require("../middlewares/heroes")
const app = express()

// request to get all heroes
app.get("/", (req, res) => {
  res.json(superHeroes)
})

// request to post a new heroe
app.post("/", verifyUser, (req, res) => {
  const { slug, name, power, color, isAlive, age, image } = req.body
  const newSuperHeroe = {
    slug: slug,
    name: name,
    power: [],
    color: color,
    isAlive: isAlive,
    age: age,
    image: image,
  }
  superHeroes.push(newSuperHeroe)
  res.json(newSuperHeroe)
})

// request to get one heroe with dynamic url
app.get("/:slug", (req, res) => {
  const alreadyExist = superHeroes.find((hero) => {
    return hero.slug === req.params.slug
  })
  if (alreadyExist) {
    res.json(alreadyExist)
  } else {
    res.status(404).json("this hero does not exist")
  }
})

// request to get all powers of one heroe with dynamic url
app.get("/:slug/powers", (req, res) => {
  const alreadyExist = superHeroes.find((hero) => {
    return hero.slug === req.params.slug
  })
  if (alreadyExist) {
    res.json(alreadyExist.power)
  } else {
    res.status(404).json("this hero does not exist")
  }
})

// request to put a new power to one heroe
app.put("/:slug/powers", (req, res) => {
  const superHeroeExistIndex = superHeroes.findIndex((hero) => {
    return hero.slug === req.params.slug
  })
  if (superHeroeExistIndex > -1) {
    // on boucle sur power et on ajoute si ya pas le meme pouvoir
    const { power } = req.body
    const superHero = superHeroes[superHeroeExistIndex]
    const powerAlreadyExist = superHero.power.includes(power)
    if (powerAlreadyExist) {
      res.status(409).json("this power already exist for this hero")
    } else {
      superHero.power.push(power)
      res.json(superHero)
    }
  } else {
    res.status(404).json("this hero does not exist")
  }
})

module.exports = app
